<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>修真RPG · 时光与寿元</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111827;
      --panel2:#0f172a;
      --card:#0b1220;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#243042;
      --accent:#60a5fa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --btn:#1f2937;
      --btn2:#111827;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% -20%, rgba(96,165,250,.25), transparent 60%),
                  radial-gradient(900px 600px at 110% 10%, rgba(52,211,153,.18), transparent 55%),
                  radial-gradient(900px 600px at 30% 120%, rgba(251,113,133,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:var(--sans);
      letter-spacing:.2px;
    }
    a{color:var(--accent); text-decoration:none}
    .app{
      max-width:1300px;
      margin:0 auto;
      padding:18px;
      display:grid;
      grid-template-columns: 320px 1fr 360px;
      gap:16px;
    }
    .topbar{
      max-width:1300px;
      margin:0 auto;
      padding:18px 18px 0 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(96,165,250,.9), rgba(52,211,153,.9));
      box-shadow: var(--shadow);
    }
    .brand h1{font-size:16px; margin:0}
    .brand .sub{font-size:12px; color:var(--muted); margin-top:2px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      background: rgba(17,24,39,.65);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .pill b{color:var(--text); font-weight:600}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .panel{
      background: rgba(17,24,39,.75);
      border:1px solid rgba(36,48,66,.85);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:14px 14px 10px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(36,48,66,.75);
      background: linear-gradient(180deg, rgba(15,23,42,.7), rgba(17,24,39,.55));
    }
    .panel .hd h2{margin:0; font-size:13px; letter-spacing:.3px}
    .panel .hd .hint{font-size:12px; color:var(--muted); margin-top:4px; line-height:1.45}
    .panel .bd{padding:14px}
    .card{
      background: rgba(11,18,32,.55);
      border:1px solid rgba(36,48,66,.7);
      border-radius:14px;
      padding:12px;
    }
    .statgrid{
      display:grid;
      grid-template-columns: repeat(2,1fr);
      gap:10px;
    }
    .kv{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(36,48,66,.55);
      background: rgba(11,18,32,.45);
      font-size:12px;
    }
    .kv span{color:var(--muted)}
    .kv b{font-weight:650}
    .progress{
      height:10px;
      border-radius:999px;
      background: rgba(36,48,66,.7);
      overflow:hidden;
      border:1px solid rgba(36,48,66,.95);
    }
    .bar{height:100%; width:0%; background: linear-gradient(90deg, rgba(96,165,250,.95), rgba(52,211,153,.85));}
    .bar.warn{background: linear-gradient(90deg, rgba(251,191,36,.95), rgba(251,113,133,.85));}
    .small{font-size:12px; color:var(--muted)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tabbtn{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(36,48,66,.75);
      background: rgba(17,24,39,.55);
      color:var(--text);
      cursor:pointer;
      font-size:12px;
      transition: .15s transform ease, .15s background ease;
    }
    .tabbtn:hover{transform: translateY(-1px); background: rgba(17,24,39,.75)}
    .tabbtn.active{border-color: rgba(96,165,250,.8); box-shadow: 0 0 0 2px rgba(96,165,250,.12) inset}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(36,48,66,.8);
      background: rgba(31,41,55,.65);
      color:var(--text);
      cursor:pointer;
      font-size:12px;
      font-weight:600;
      transition: .15s transform ease, .15s background ease, .15s border ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(31,41,55,.85)}
    .btn:active{transform: translateY(0px)}
    .btn.primary{background: rgba(96,165,250,.22); border-color: rgba(96,165,250,.75)}
    .btn.good{background: rgba(52,211,153,.18); border-color: rgba(52,211,153,.65)}
    .btn.warn{background: rgba(251,191,36,.15); border-color: rgba(251,191,36,.55)}
    .btn.bad{background: rgba(251,113,133,.15); border-color: rgba(251,113,133,.55)}
    .btn:disabled{opacity:.5; cursor:not-allowed; transform:none}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap}
    .split{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:12px;
    }
    .field{
      display:flex; flex-direction:column; gap:6px;
    }
    label{font-size:12px; color:var(--muted)}
    select,input[type="number"],input[type="text"]{
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(36,48,66,.85);
      background: rgba(11,18,32,.6);
      color:var(--text);
      outline:none;
      font-size:12px;
    }
    input[type="checkbox"]{transform: translateY(1px)}
    .checkline{display:flex; gap:10px; flex-wrap:wrap}
    .check{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(36,48,66,.65);
      background: rgba(11,18,32,.45);
      font-size:12px;
      color:var(--text);
    }
    .muted{color:var(--muted)}
    .tag{
      display:inline-flex;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(36,48,66,.65);
      font-size:11px;
      color:var(--muted);
      background: rgba(11,18,32,.45);
    }
    .tag.good{border-color: rgba(52,211,153,.6); color: rgba(52,211,153,.95)}
    .tag.warn{border-color: rgba(251,191,36,.6); color: rgba(251,191,36,.95)}
    .tag.bad{border-color: rgba(251,113,133,.6); color: rgba(251,113,133,.95)}
    .hr{height:1px; background: rgba(36,48,66,.65); margin:12px 0}
    .log{
      display:flex; flex-direction:column; gap:8px;
      max-height: 680px;
      overflow:auto;
      padding-right:6px;
    }
    .log::-webkit-scrollbar{width:8px}
    .log::-webkit-scrollbar-thumb{background: rgba(36,48,66,.8); border-radius:999px}
    .entry{
      border:1px solid rgba(36,48,66,.75);
      background: rgba(11,18,32,.55);
      border-radius:14px;
      padding:10px 10px;
      line-height:1.45;
      font-size:12px;
    }
    .entry .meta{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:6px}
    .entry .meta .t{font-family:var(--mono); font-size:11px; color:var(--muted)}
    .entry .meta .k{display:flex; gap:6px; align-items:center}
    .entry .meta .k .tag{font-size:10px}
    .entry .txt{white-space:pre-wrap}
    .pager{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:10px}
    .pager .btn{padding:8px 10px}
    .modalWrap{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index: 50;
    }
    .modal{
      width:min(860px, 96vw);
      border-radius: 18px;
      background: rgba(17,24,39,.92);
      border:1px solid rgba(36,48,66,.85);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .hd{padding:14px; border-bottom:1px solid rgba(36,48,66,.7); display:flex; align-items:center; justify-content:space-between; gap:10px}
    .modal .hd h3{margin:0; font-size:13px}
    .modal .bd{padding:14px}
    .modal .ft{padding:14px; border-top:1px solid rgba(36,48,66,.7); display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap}
    .cols2{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .mono{font-family:var(--mono)}
    .danger{color: var(--bad)}
    .goodtxt{color: var(--good)}
    .warntxt{color: var(--warn)}
    @media (max-width: 1100px){
      .app{grid-template-columns: 1fr; }
      .topbar{flex-direction:column; align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>修真RPG · 时光与寿元</h1>
        <div class="sub">修炼变慢、选择更重；十年闭关不会轻易炸炉，但会错过世界窗口。</div>
      </div>
    </div>
    <div class="row">
      <div class="pill"><span>当前：</span><b id="nowText">—</b></div>
      <div class="pill"><span>地点：</span><b id="locText">—</b></div>
      <div class="pill"><span>寿元：</span><b id="lifeText">—</b></div>
      <button class="btn" id="btnSave">保存</button>
      <button class="btn" id="btnExport">导出</button>
      <button class="btn" id="btnImport">导入</button>
      <button class="btn" id="btnReset">重开</button>
    </div>
  </div>

  <div class="app">
    <!-- Left -->
    <section class="panel" id="panelChar">
      <div class="hd">
        <div>
          <h2>角色面板</h2>
          <div class="hint" id="charHint">—</div>
        </div>
        <span class="tag" id="tagAlign">—</span>
      </div>
      <div class="bd">
        <div class="card">
          <div class="kv"><span>境界</span><b id="realmText">—</b></div>
          <div style="margin-top:10px">
            <div class="small" style="display:flex; justify-content:space-between; gap:10px">
              <span>修为进度</span><span class="mono" id="xpText">—</span>
            </div>
            <div class="progress" style="margin-top:6px"><div class="bar" id="xpBar"></div></div>
          </div>
          <div style="margin-top:10px">
            <div class="small" style="display:flex; justify-content:space-between; gap:10px">
              <span>主修功法</span><span class="mono" id="techText">—</span>
            </div>
            <div class="progress" style="margin-top:6px"><div class="bar" id="techBar"></div></div>
          </div>
          <div style="margin-top:10px">
            <div class="small" style="display:flex; justify-content:space-between; gap:10px">
              <span>气血</span><span class="mono" id="hpText">—</span>
            </div>
            <div class="progress" style="margin-top:6px"><div class="bar warn" id="hpBar"></div></div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="statgrid">
          <div class="kv"><span>灵石</span><b id="stoneText">—</b></div>
          <div class="kv"><span>悟性点</span><b id="insText">—</b></div>
          <div class="kv"><span>攻击</span><b id="atkText">—</b></div>
          <div class="kv"><span>防御</span><b id="defText">—</b></div>
          <div class="kv"><span>身法</span><b id="agiText">—</b></div>
          <div class="kv"><span>心境</span><b id="mindText">—</b></div>
        </div>

        <div class="hr"></div>

        <div class="card">
          <div class="small" style="display:flex; justify-content:space-between; gap:10px">
            <span>状态</span><span class="mono" id="statusText">—</span>
          </div>
          <div class="small" style="margin-top:8px; line-height:1.6" id="statusDesc">—</div>
        </div>
      </div>
    </section>

    <!-- Middle -->
    <section class="panel" id="panelMain">
      <div class="hd">
        <div>
          <h2>行动</h2>
          <div class="hint" id="mainHint">请选择一个行动页签。</div>
        </div>
        <div class="tabs" id="tabs"></div>
      </div>
      <div class="bd" id="mainBody"></div>
    </section>

    <!-- Right -->
    <section class="panel" id="panelLog">
      <div class="hd">
        <div>
          <h2>事件日志</h2>
          <div class="hint">最新在上。支持分页，避免日志过长影响体验。</div>
        </div>
        <div class="row">
          <button class="btn" id="btnClearLog">清空</button>
        </div>
      </div>
      <div class="bd">
        <div class="card">
          <div class="small">世界窗口预告（未来12个月）</div>
          <div class="small" style="margin-top:8px; line-height:1.55" id="upcomingText">—</div>
        </div>
        <div class="hr"></div>
        <div class="log" id="logList"></div>
        <div class="pager">
          <button class="btn" id="btnPrev">上一页</button>
          <div class="small mono" id="pageInfo">—</div>
          <button class="btn" id="btnNext">下一页</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div class="modalWrap" id="modalWrap" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="hd">
        <h3 id="modalTitle">—</h3>
        <button class="btn" id="modalClose">关闭</button>
      </div>
      <div class="bd" id="modalBody"></div>
      <div class="ft" id="modalFoot"></div>
    </div>
  </div>

<script>
/* =========================
   修真RPG · 时光与寿元（单文件）
   设计口径：10年闭关风险可控，主要代价是错过窗口
   ========================= */

const VERSION = "rpg-v1.0.0";
const STORAGE_KEY = "xiuzhen_rpg_save_v1";

// 时间：采用 360 天/年（方便计算）
const DAYS_PER_YEAR = 360;

const REALMS = [
  { key:"LQ", name:"炼气", stages:["初期","中期","后期"], lifeCapYears: 90,  lifeRejuvenate: 0 },
  { key:"ZJ", name:"筑基", stages:["初期","中期","后期"], lifeCapYears: 150, lifeRejuvenate: 30 },
  { key:"JD", name:"金丹", stages:["初期","中期","后期"], lifeCapYears: 270, lifeRejuvenate: 60 },
  { key:"YY", name:"元婴", stages:["初期","中期","后期"], lifeCapYears: 470, lifeRejuvenate: 100 },
  { key:"HS", name:"化神", stages:["初期","中期","后期"], lifeCapYears: 770, lifeRejuvenate: 150 },
];

const ENVIRONMENTS = [
  { id:"wild", name:"野外洞府", eff:1.00, risk:1.00, costStone:0,  insight:1.00 },
  { id:"sect", name:"宗门洞府", eff:1.20, risk:0.85, costStone:120, insight:1.05 },
  { id:"ley",  name:"灵脉福地", eff:1.50, risk:0.92, costStone:450, insight:1.25 },
];

const SUPPLIES = {
  assistPill: { id:"assistPill",  name:"助修丹",   desc:"修为效率 +20%", costStone:160, eff:1.20, riskMul:1.00, mindBonus:0 },
  protectPill:{ id:"protectPill", name:"护脉丹",   desc:"走火概率 -40%", costStone:180, eff:1.00, riskMul:0.60, mindBonus:0 },
  wardTalis:  { id:"wardTalis",   name:"辟邪符",   desc:"心魔概率 -40%", costStone:140, eff:1.00, riskMul:1.00, mindBonus:+1, demonMul:0.60 },
  stablePow:  { id:"stablePow",   name:"巩固散",   desc:"突破失败惩罚减半（一次）", costStone:200, eff:1.00, riskMul:1.00, mindBonus:0, failShield:true },
};

const AGENT_TASKS = [
  { id:"none", name:"不指派" },
  { id:"buy", name:"代购突破材料", desc:"降低突破所需灵石/材料压力（以灵石返还形式体现）" },
  { id:"intel", name:"盯梢秘境情报", desc:"降低错过秘境的损失（部分改为线索）" },
  { id:"contrib", name:"处理宗门差事", desc:"闭关期间仍可获得少量贡献与声望" },
];

const REGIONS = [
  { id:"qingzhou", name:"青州", tierHint:"三流地界", mainRealmIdx:0 }, // 炼气为主
  { id:"yuzhou", name:"豫州", tierHint:"二流要冲", mainRealmIdx:1 },   // 筑基为主
  { id:"lingnan", name:"岭南", tierHint:"灵脉密集", mainRealmIdx:2 },  // 金丹为主
];

// =========================
// State
// =========================

function newGame(){
  const startYear = 1, startDay = 1;
  const dayAbs = (startYear-1)*DAYS_PER_YEAR + (startDay-1);
  const s = {
    version: VERSION,
    time: { dayAbs, startDayAbs: dayAbs },
    player: {
      name: "无名散修",
      align: 0, // -100邪 +100正
      realmIdx: 0,
      stageIdx: 0,
      xp: 0,
      xpNeed: xpNeed(0,0),
      tech: 0,      // 0..1000
      techNeed: 1000,
      insight: 0,
      stones: 500,
      hp: 120,
      maxHp: 120,
      atk: 12,
      def: 8,
      agi: 10,
      mind: 0, // 心境（-5..+10）
      injury: null, // {type, daysLeft, desc, effMul}
      demonMark: 0, // 心魔印记层数
      unstableDays: 0, // 境界不稳需要巩固
      sect: { joined:false, name:"", tier:"", align:"", fame:0, contrib:0 },
      world: { regionId:"qingzhou", loc:"野外" },
      life: { ageDays: 18*DAYS_PER_YEAR, capDays: REALMS[0].lifeCapYears*DAYS_PER_YEAR }, // 18岁起步
      bag: { stabilizePow:0 },
    },
    world: {
      windows: [], // {id,type,name,regionId,startAbs,endAbs,desc,claimedBy?}
      lastWindowGenYear: 0,
      npcs: { rivals: [] }, // {name, realmIdx, stageIdx, faction, hatred}
      lastChronicle: null,
    },
    ui: { tab:"cultivate", logPage:0 },
    log: [],
  };

  // 新手引导窗口
  pushLog(s, "系统", "你初入修行，寿元有限。修炼要慢，但每一步要有选择。建议：先在【修炼/闭关】做一次30天巩固。", "info");
  ensureWindowsForYear(s, getYear(s)); // 生成当年窗口
  recalcStats(s);
  return s;
}

// =========================
// Utilities
// =========================

function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function rand(){ return Math.random(); }
function randi(a,b){ return Math.floor(a + rand()*(b-a+1)); }
function pick(arr){ return arr[randi(0, arr.length-1)]; }
function fmt(n){ return (Math.round(n*100)/100).toLocaleString("zh-CN"); }

function getYear(state){
  return Math.floor(state.time.dayAbs / DAYS_PER_YEAR) + 1;
}
function getDayOfYear(state){
  return (state.time.dayAbs % DAYS_PER_YEAR) + 1;
}
function dateText(state){
  const y = getYear(state), d = getDayOfYear(state);
  return `第${y}年·第${d}日`;
}
function ageYears(state){
  return state.player.life.ageDays / DAYS_PER_YEAR;
}
function lifeLeftDays(state){
  return state.player.life.capDays - state.player.life.ageDays;
}
function lifeText(state){
  const left = lifeLeftDays(state);
  const leftY = left / DAYS_PER_YEAR;
  return `剩余${Math.max(0, leftY).toFixed(1)}年 / 上限${(state.player.life.capDays/DAYS_PER_YEAR).toFixed(0)}年`;
}

function realmName(state){
  const r = REALMS[state.player.realmIdx];
  return `${r.name}${r.stages[state.player.stageIdx]}`;
}

function xpNeed(realmIdx, stageIdx){
  // 递增曲线：前期快，后期慢；每大境界提升明显
  const realmMul = [1.0, 2.2, 4.2, 7.5, 12.0][realmIdx] ?? (1+realmIdx*2.5);
  const stageMul = [1.0, 1.25, 1.55][stageIdx] ?? 1.0;
  return Math.floor(120 * realmMul * stageMul);
}

function recalcStats(state){
  const p = state.player;

  // 基础随境界增长，且大境界质变更明显
  const realmBase = [0, 18, 45, 85, 140][p.realmIdx] ?? (p.realmIdx*30);
  const stageBase = [0, 8, 16][p.stageIdx] ?? 0;

  p.maxHp = 110 + realmBase*3 + stageBase*2;
  p.atk = 10 + realmBase*1.7 + stageBase*1.3 + Math.floor(p.tech/120);
  p.def = 8 + realmBase*1.5 + stageBase*1.2 + Math.floor(p.tech/160);
  p.agi = 10 + Math.floor(realmBase*0.55) + Math.floor(p.tech/200);

  // 伤势与不稳影响
  let effMul = 1.0;
  if(p.injury) effMul *= (p.injury.effMul ?? 0.85);
  if(p.unstableDays>0) effMul *= 0.92;

  // mind 影响轻微
  p.mind = clamp(p.mind, -5, 10);

  // hp 不超过上限
  p.hp = clamp(p.hp, 0, p.maxHp);
  p._cultEffMul = effMul;
}

// 日志：最新在上
function pushLog(state, kind, text, tone="info"){
  const t = dateText(state);
  state.log.unshift({
    t, kind, tone, text,
    id: `${Date.now()}_${Math.random().toString(16).slice(2)}`
  });
  // 限制长度
  if(state.log.length > 1200) state.log.length = 1200;
}

function toneTag(tone){
  if(tone==="good") return "good";
  if(tone==="warn") return "warn";
  if(tone==="bad") return "bad";
  return "";
}

// =========================
// Windows (world events)
// =========================
function ensureWindowsForYear(state, year){
  if(state.world.lastWindowGenYear >= year) return;

  // 生成从 last+1 到 year 的窗口
  for(let y=state.world.lastWindowGenYear+1; y<=year; y++){
    const yearStart = (y-1)*DAYS_PER_YEAR;
    // 1) 秘境窗口
    const secretStart = yearStart + randi(20, 260);
    const secretLen = randi(30, 120);
    const region = pick(REGIONS).id;
    state.world.windows.push({
      id:`sr_${y}_${region}`,
      type:"secret",
      name:`秘境·${pick(["残阳","青冥","玄水","龙渊","离火","归墟"])}洞天`,
      regionId: region,
      startAbs: secretStart,
      endAbs: secretStart+secretLen,
      desc:"秘境开放窗口短暂，闭关过久可能错过首波机缘。",
      claimedBy: null,
    });

    // 2) 拍卖会窗口（城镇）
    const aucStart = yearStart + randi(40, 310);
    const aucLen = randi(10, 20);
    state.world.windows.push({
      id:`auc_${y}`,
      type:"auction",
      name:`拍卖会·${pick(["云海","天宝","琉璃","万象"])}楼`,
      regionId: pick(REGIONS).id,
      startAbs: aucStart,
      endAbs: aucStart+aucLen,
      desc:"稀缺丹方与灵材流通，错过则价格上浮或被势力垄断。",
      claimedBy: null,
    });

    // 3) 宗门大比（若已入宗门则更重要）
    const tourStart = yearStart + randi(90, 330);
    const tourLen = randi(15, 30);
    state.world.windows.push({
      id:`tour_${y}`,
      type:"sect",
      name:`宗门大比`,
      regionId: state.player.world.regionId,
      startAbs: tourStart,
      endAbs: tourStart+tourLen,
      desc:"升迁、内门名额、长老收徒窗口。闭关可能错过。",
      claimedBy: null,
    });
  }

  state.world.lastWindowGenYear = year;
}

function upcomingText(state){
  const now = state.time.dayAbs;
  const limit = now + DAYS_PER_YEAR; // 12个月
  const upcoming = state.world.windows
    .filter(w => w.endAbs >= now && w.startAbs <= limit)
    .sort((a,b)=>a.startAbs-b.startAbs)
    .slice(0,6);

  if(upcoming.length===0) return "暂无窗口。";

  const lines = upcoming.map(w=>{
    const startY = Math.floor(w.startAbs / DAYS_PER_YEAR)+1;
    const startD = (w.startAbs % DAYS_PER_YEAR)+1;
    const endY = Math.floor(w.endAbs / DAYS_PER_YEAR)+1;
    const endD = (w.endAbs % DAYS_PER_YEAR)+1;
    const region = REGIONS.find(r=>r.id===w.regionId)?.name ?? "未知";
    const tag = w.type==="secret"?"秘境":(w.type==="auction"?"交易":"宗门");
    return `【${tag}】${w.name}（${region}）  第${startY}年·${startD}日 ~ 第${endY}年·${endD}日`;
  });

  return lines.join("\n");
}

// 结算错过窗口（闭关结束调用）
function settleMissedWindows(state, startAbs, endAbs, agentTaskId){
  const missed = state.world.windows.filter(w => w.startAbs >= startAbs && w.endAbs <= endAbs);
  if(missed.length===0){
    return { missed:[], notes:["十年/多年间天下无大波澜，你并未错过重要窗口。"] };
  }

  // 生成“谁拿走了机缘”
  const notes = [];
  const rivals = state.world.npcs.rivals;

  function genRivalName(){
    const fam = pick(["顾","沈","陆","韩","白","叶","秦","姜","萧","苏","楚","唐"]);
    const name = pick(["玄","凌","尘","渊","霜","曜","岚","衡","离","珩","泽","昀"]);
    const suf = pick(["","子","然","舟","宁","冥","霖"]);
    return fam+name+suf;
  }

  for(const w of missed){
    if(!w.claimedBy){
      const r = {
        name: genRivalName(),
        realmIdx: clamp(state.player.realmIdx + pick([-1,0,0,0,1]), 0, REALMS.length-1),
        stageIdx: randi(0,2),
        faction: pick(["正道","邪修","散修","宗门客卿"]),
        hatred: 0,
      };
      rivals.push(r);
      w.claimedBy = r.name;
    }
  }

  // 代理人补救
  const agentNotes = [];
  if(agentTaskId && agentTaskId !== "none"){
    const fame = state.player.sect.fame ?? 0;
    const base = 0.35 + clamp(fame/200, 0, 0.25); // 0.35~0.60
    const cost = 80;
    if(state.player.stones >= cost){
      state.player.stones -= cost;
      const ok = rand() < base;
      if(ok){
        if(agentTaskId==="buy"){
          const refund = 160 + randi(0,120);
          state.player.stones += refund;
          agentNotes.push(`代理人成功代购材料，灵石返还 +${refund}。`);
        } else if(agentTaskId==="intel"){
          state.player.insight += 2;
          agentNotes.push(`代理人带回秘境线索，你获得悟性点 +2（可用于突破）。`);
        } else if(agentTaskId==="contrib"){
          if(state.player.sect.joined){
            state.player.sect.contrib += 40;
            state.player.sect.fame += 10;
            agentNotes.push(`代理人处理宗门差事，你获得贡献 +40，声望 +10。`);
          } else {
            state.player.stones += 60;
            agentNotes.push(`代理人以散修身份接小差事，灵石 +60。`);
          }
        }
      }else{
        agentNotes.push(`代理人行事不利，仅带回零碎消息，未能有效补救。`);
      }
    }else{
      agentNotes.push(`你未预留足够灵石（${cost}）供代理人运作，本次未能启用代理。`);
    }
  }

  // 形成大事记
  notes.push(`你闭关期间共错过 ${missed.length} 个窗口：`);
  for(const w of missed.slice(0,6)){
    const region = REGIONS.find(r=>r.id===w.regionId)?.name ?? "未知";
    const tag = w.type==="secret"?"秘境":(w.type==="auction"?"交易":"宗门");
    notes.push(`- 【${tag}】${w.name}（${region}）被 ${w.claimedBy} 抢得先机。`);
  }
  if(missed.length>6) notes.push(`- ……其余 ${missed.length-6} 个窗口略。`);

  // 影响：错过秘境会让你下次探索更可能出现“残图”事件
  const secretCount = missed.filter(x=>x.type==="secret").length;
  if(secretCount>0){
    state.world._missedSecretBuff = (state.world._missedSecretBuff ?? 0) + secretCount;
    notes.push(`余波：秘境余韵尚存，未来探索更易获得“残图/传闻”。`);
  }

  notes.push(...agentNotes);

  return { missed, notes };
}

// =========================
// Core: advance time & checks
// =========================
function advanceDays(state, days, reason="行动"){
  if(days<=0) return;
  const p = state.player;
  const startAbs = state.time.dayAbs;
  const endAbs = startAbs + days;

  // 每推进跨年就生成窗口
  const startYear = getYear(state);
  state.time.dayAbs = endAbs;
  const endYear = getYear(state);
  ensureWindowsForYear(state, endYear);

  // 年龄与寿元消耗
  p.life.ageDays += days;

  // 伤势恢复/不稳巩固倒计时
  if(p.injury){
    p.injury.daysLeft -= days;
    if(p.injury.daysLeft <= 0){
      pushLog(state, "恢复", `伤势已愈，你的气血与行功不再受限。`, "good");
      p.injury = null;
    }
  }
  if(p.unstableDays>0){
    p.unstableDays = Math.max(0, p.unstableDays - days);
    if(p.unstableDays===0){
      pushLog(state, "巩固", "境界已稳，气机圆融。", "good");
    }
  }

  // 小量自然回血（非重伤）
  const healRate = p.injury ? 0.06 : 0.12;
  p.hp = clamp(p.hp + Math.floor(days * healRate * (p.maxHp/30)), 0, p.maxHp);

  // 死亡判定
  if(p.life.ageDays >= p.life.capDays){
    gameOver(state);
    return;
  }

  recalcStats(state);
}

function gameOver(state){
  pushLog(state, "结局", `寿元耗尽。你止步于 ${realmName(state)}，江湖只留下些许传闻。`, "bad");
  state._gameOver = true;
  openModal(
    "寿元已尽",
    `<div class="card">
      <div class="small">你已走到生命尽头。</div>
      <div class="hr"></div>
      <div class="small">最终境界：<b>${realmName(state)}</b></div>
      <div class="small">生年：<b>${getYear(state)}年</b></div>
      <div class="small">灵石：<b>${fmt(state.player.stones)}</b>，悟性点：<b>${state.player.insight}</b></div>
      <div class="small">你可以选择重开，或导出存档留念。</div>
    </div>`,
    [
      { text:"导出存档", cls:"btn", onClick: ()=>exportSave(state) },
      { text:"重开", cls:"btn primary", onClick: ()=>{ closeModal(); stateReplace(newGame()); } },
      { text:"关闭", cls:"btn", onClick: ()=>closeModal() },
    ]
  );
}

// =========================
// Cultivation / Retreat
// =========================

function calcBaseCultivationPerDay(state){
  // 基础修炼速度：前期不至于太慢，但总体拉长
  const p=state.player;
  const realmRate = [1.0, 1.35, 1.75, 2.2, 2.75][p.realmIdx] ?? (1+p.realmIdx*0.4);
  const stageRate = [1.0, 1.08, 1.16][p.stageIdx] ?? 1.0;
  const techRate = 1.0 + (p.tech/1000)*0.35;
  const mindRate = 1.0 + (p.mind/20); // -5..+10 => 0.75..1.5
  const age = ageYears(state);
  const agePenalty = (age<=45)?1.0 : (age<=80? (1.0 - (age-45)/350) : 0.90); // 温和衰老
  return 2.0 * realmRate * stageRate * techRate * mindRate * agePenalty * (p._cultEffMul ?? 1.0);
}

function calcTechGainPerDay(state){
  const p=state.player;
  const realmRate = [1.0, 1.10, 1.20, 1.35, 1.50][p.realmIdx] ?? 1.0;
  return 1.2 * realmRate * (p._cultEffMul ?? 1.0);
}

function retreatRiskProfile(durationDays){
  // 口径2：风险可控
  if(durationDays<=30) return { qi:0.01, demon:0.02 };
  if(durationDays<=360) return { qi:0.03, demon:0.05 };
  return { qi:0.06, demon:0.08 };
}

function runRetreat(state, plan){
  const p=state.player;
  if(state._gameOver) return;

  // 费用
  const env = ENVIRONMENTS.find(e=>e.id===plan.envId) ?? ENVIRONMENTS[0];
  let cost = env.costStone || 0;

  let effMul = env.eff;
  let qiMul = env.risk;  // 影响走火概率
  let demonMul = 1.0;    // 影响心魔概率
  let mindBonus = 0;

  const chosen = [];
  for(const key of ["assistPill","protectPill","wardTalis","stablePow"]){
    if(plan.supplies?.[key]){
      const it = SUPPLIES[key];
      cost += it.costStone;
      effMul *= (it.eff ?? 1.0);
      qiMul *= (it.riskMul ?? 1.0);
      demonMul *= (it.demonMul ?? 1.0);
      mindBonus += (it.mindBonus ?? 0);
      chosen.push(it.name);
      if(it.failShield) p.bag.stabilizePow = (p.bag.stabilizePow ?? 0) + 1;
    }
  }

  if(p.stones < cost){
    pushLog(state, "闭关", `灵石不足（需要${cost}，仅有${p.stones}）。闭关方案取消。`, "warn");
    return;
  }
  p.stones -= cost;

  const startAbs = state.time.dayAbs;
  const days = plan.days;

  pushLog(state, "闭关", `你选择闭关 ${fmt(days)} 天（${env.name}），备品：${chosen.length?chosen.join("、"):"无"}。`, "info");

  // 分块结算（每30天一次），以便插入心魔/走火事件
  const chunk = 30;
  let remain = days;

  // 记录闭关期间错过窗口（在最后统一结算）
  let qiEvents = 0, demonEvents = 0;

  while(remain>0 && !state._gameOver){
    const step = Math.min(chunk, remain);

    // 修为与功法增长
    const baseCult = calcBaseCultivationPerDay(state);
    const baseTech = calcTechGainPerDay(state);

    const gainXP = baseCult * effMul * step;
    const gainTech = baseTech * effMul * step;

    p.xp += gainXP;
    p.tech = clamp(p.tech + gainTech, 0, 1000);

    // 悟性：闭关少量产出（更依赖事件/心魔/秘境）
    const insightGain = (rand() < 0.08 ? 1 : 0) * (env.insight>=1.2 ? 1 : 1);
    if(insightGain>0) p.insight += insightGain;

    // 心境小幅提升（长期闭关更稳）
    p.mind = clamp(p.mind + mindBonus*0.15, -5, 10);

    // 风险判定
    const risk = retreatRiskProfile(days);
    const qiChance = risk.qi * qiMul * (p.injury?1.2:1.0);
    const demonChance = risk.demon * demonMul * (1 + p.demonMark*0.18);

    // 走火事件（温和后果）
    if(rand() < qiChance){
      qiEvents++;
      const inj = {
        type:"内伤",
        daysLeft: randi(20, 45),
        effMul: 0.80,
        desc:"经脉受阻，行功不畅（修炼效率降低）"
      };
      p.injury = inj;
      p.hp = clamp(p.hp - Math.floor(p.maxHp*0.22), 0, p.maxHp);
      p.mind = clamp(p.mind - 1, -5, 10);
      pushLog(state, "走火", `闭关中气机反噬，落下【${inj.type}】（需${inj.daysLeft}天恢复）。`, "warn");
    }

    // 心魔事件：内容化（简化为一次抉择）
    if(rand() < demonChance){
      demonEvents++;
      p.demonMark += 1;
      pushLog(state, "心魔", "你在冥想中见到旧日执念化形，心魔来袭。", "warn");
      // 立刻处理一次心魔抉择（不中断闭关，但会影响状态）
      resolveHeartDemonAuto(state, plan.demonPolicy || "suppress");
    }

    // 时间推进（寿元消耗、恢复结算）
    advanceDays(state, step, "闭关");
    remain -= step;

    // 达到突破门槛后不自动突破，但允许继续闭关（溢出存储）
    // 不阻断循环：更贴合“闭关一口气很多年”
  }

  // 闭关结束：错过窗口大事记（口径2核心）
  if(!state._gameOver){
    const agentTaskId = plan.agentTaskId ?? "none";
    const chron = settleMissedWindows(state, startAbs, startAbs+days, agentTaskId);
    state.world.lastChronicle = chron;

    if(chron.notes?.length){
      pushLog(state, "十年大事记", chron.notes.join("\n"), "info");
      openModal(
        "闭关大事记",
        `<div class="card"><div class="small">你出关回望，世事如潮。</div><div class="hr"></div>
         <div class="small" style="white-space:pre-wrap; line-height:1.6">${escapeHtml(chron.notes.join("\n"))}</div></div>`,
        [{ text:"知道了", cls:"btn primary", onClick: ()=>closeModal() }]
      );
    }
  }

  // 修为门槛提示
  if(canBreakthrough(state)){
    pushLog(state, "突破", "你气机已满，可以尝试突破（进入【突破】页签）。", "good");
  }

  recalcStats(state);
}

// 心魔事件（闭关内自动处理）：玩家在闭关方案里选择心魔策略
function resolveHeartDemonAuto(state, policy){
  const p=state.player;
  // policy: suppress / confront / enlighten
  if(policy==="suppress"){
    // 稳定优先：成功率高，收益低
    const ok = willCheck(state, 0.78);
    p.mind = clamp(p.mind - 0.4, -5, 10);
    if(ok){
      p.demonMark = Math.max(0, p.demonMark - 1);
      pushLog(state, "心魔", "你选择镇压心魔，执念渐退，气机趋稳。", "good");
    }else{
      pushLog(state, "心魔", "你镇压不彻底，执念仍存（心魔印记未退）。", "warn");
    }
    return;
  }
  if(policy==="confront"){
    const ok = willCheck(state, 0.55);
    if(ok){
      p.insight += 1;
      p.mind = clamp(p.mind + 0.4, -5, 10);
      p.demonMark = Math.max(0, p.demonMark - 1);
      pushLog(state, "心魔", "你正面应对心魔，心中清明，悟性点 +1。", "good");
    }else{
      p.mind = clamp(p.mind - 1.0, -5, 10);
      p.hp = clamp(p.hp - Math.floor(p.maxHp*0.10), 0, p.maxHp);
      pushLog(state, "心魔", "你被旧念缠身，心神受创（气血下降）。", "warn");
    }
    return;
  }
  // enlighten
  const ok = willCheck(state, 0.45);
  if(ok){
    p.insight += 2;
    p.mind = clamp(p.mind + 0.8, -5, 10);
    p.demonMark = Math.max(0, p.demonMark - 1);
    pushLog(state, "悟道", "你借心魔磨砺道心，豁然开朗，悟性点 +2。", "good");
  }else{
    p.demonMark += 1;
    p.mind = clamp(p.mind - 1.3, -5, 10);
    p.unstableDays += 20;
    pushLog(state, "悟道", "你强行借势失败，心魔印记加深，境界不稳（需巩固）。", "bad");
  }
}

// 意志判定：受心境、境界、年龄影响
function willCheck(state, base){
  const p=state.player;
  const realmBonus = p.realmIdx*0.05;
  const mindBonus = p.mind*0.02;
  const age = ageYears(state);
  const agePenalty = age>80 ? -0.06 : (age>60 ? -0.03 : 0);
  const demonPenalty = -p.demonMark*0.04;
  const chance = clamp(base + realmBonus + mindBonus + agePenalty + demonPenalty, 0.05, 0.95);
  return rand() < chance;
}

// =========================
// Breakthrough
// =========================

function canBreakthrough(state){
  const p=state.player;
  // 末阶段满了可突破到下一阶段/大境界
  return p.xp >= p.xpNeed && !state._gameOver;
}

function prepTier(state){
  const p=state.player;

  // 计算准备度 0..100
  const fullness = clamp(p.xp / p.xpNeed, 0, 1);
  const tech = p.tech / 1000;
  const mind = (p.mind + 5) / 15; // 0..1
  const health = p.injury ? 0.55 : 1.0;
  const demon = clamp(1 - p.demonMark*0.12, 0.3, 1.0);
  const stable = p.unstableDays>0 ? 0.75 : 1.0;

  // 口径2：准备是核心
  const score = (fullness*36 + tech*22 + mind*14 + health*12 + demon*10 + stable*6);

  let tier="低", range=[0.35,0.50];
  if(score>=70){ tier="极高"; range=[0.78,0.92]; }
  else if(score>=55){ tier="高"; range=[0.62,0.78]; }
  else if(score>=40){ tier="中"; range=[0.50,0.62]; }

  // 若你有悟性点可用于加持，提高下限
  return { score: Math.round(score), tier, range };
}

function attemptBreakthrough(state, spendInsight){
  const p=state.player;
  if(!canBreakthrough(state)) return;

  const {score,tier,range} = prepTier(state);

  let bonus = 0;
  if(spendInsight){
    const spend = Math.min(p.insight, 3);
    p.insight -= spend;
    bonus += spend*0.04; // 每点悟性 +4%
    pushLog(state, "突破", `你以悟性加持冲关（消耗悟性点 ${spend}）。`, "info");
  }

  // 环境：若在灵脉/宗门更稳
  const loc = state.player.world.loc;
  let envBonus = 0;
  if(loc.includes("洞府") || loc.includes("宗门")) envBonus += 0.03;
  if(loc.includes("灵脉")) envBonus += 0.06;

  // 若有巩固散保底：失败惩罚减半一次
  const hasShield = (p.bag.stabilizePow ?? 0) > 0;

  const chance = clamp(range[0] + (range[1]-range[0])*(score/100) + bonus + envBonus, 0.08, 0.97);
  const roll = rand();

  if(roll < chance){
    doBreakthroughSuccess(state);
  }else{
    doBreakthroughFail(state, hasShield);
  }

  recalcStats(state);
}

function doBreakthroughSuccess(state){
  const p=state.player;

  // 前进：先升小境界，满则升大境界
  let newRealm = p.realmIdx;
  let newStage = p.stageIdx + 1;
  let advancedMajor = false;

  if(newStage >= 3){
    newStage = 0;
    newRealm = Math.min(REALMS.length-1, p.realmIdx + 1);
    advancedMajor = (newRealm !== p.realmIdx);
  }

  p.realmIdx = newRealm;
  p.stageIdx = newStage;

  // 重置修为（溢出保留一部分）
  const overflow = Math.max(0, p.xp - p.xpNeed);
  p.xpNeed = xpNeed(p.realmIdx, p.stageIdx);
  p.xp = overflow*0.25;

  // 境界不稳：需要巩固（口径2：轻惩罚）
  p.unstableDays = randi(20, 40);

  // 大境界增寿（并回春）
  if(advancedMajor){
    const cap = REALMS[p.realmIdx].lifeCapYears * DAYS_PER_YEAR;
    const oldCap = p.life.capDays;
    p.life.capDays = Math.max(p.life.capDays, cap);
    const rejuvenate = REALMS[p.realmIdx].lifeRejuvenate * DAYS_PER_YEAR;
    p.life.ageDays = Math.max(0, p.life.ageDays - rejuvenate);
    pushLog(state, "大突破", `你踏入【${realmName(state)}】！寿元上限提升，回春 ${(rejuvenate/DAYS_PER_YEAR).toFixed(0)} 年。`, "good");
  }else{
    pushLog(state, "突破", `你突破至【${realmName(state)}】（需巩固${p.unstableDays}天）。`, "good");
  }
}

function doBreakthroughFail(state, shield){
  const p=state.player;
  let penaltyMul = shield ? 0.5 : 1.0;

  if(shield){
    p.bag.stabilizePow = Math.max(0, (p.bag.stabilizePow ?? 0) - 1);
    pushLog(state, "保底", "巩固散生效：失败惩罚减半（消耗1份）。", "good");
  }

  // 口径2：失败更像延期成本
  const lostXP = Math.floor(p.xpNeed * 0.12 * penaltyMul);
  p.xp = Math.max(0, p.xp - lostXP);

  const injDays = Math.floor(randi(12, 28) * penaltyMul);
  p.injury = {
    type:"冲关反噬",
    daysLeft: injDays,
    effMul: 0.85,
    desc:"冲关反噬，需静养恢复（修炼效率降低）"
  };

  p.mind = clamp(p.mind - 0.8*penaltyMul, -5, 10);
  p.demonMark += (rand()<0.35 ? 1 : 0);
  p.unstableDays += Math.floor(15 * penaltyMul);

  pushLog(state, "失败", `冲关未成（修为-${lostXP}），并落下【${p.injury.type}】（需${injDays}天）。`, "warn");
}

// =========================
// Exploration (minimal MVP)
// =========================
function explore(state, days){
  const p=state.player;
  if(state._gameOver) return;

  pushLog(state, "探索", `你在${REGIONS.find(r=>r.id===p.world.regionId)?.name ?? "未知"}一带游历 ${days} 天。`, "info");

  // 先推进时间（探索本质是时间成本）
  advanceDays(state, days, "探索");
  if(state._gameOver) return;

  // 单次事件（MVP）：避免一次探索触发多次弹窗
  const long = days >= 30;
  const r = rand();

  if(r < 0.60){
    const gain = randi(long?80:30, long?180:90);
    p.stones += gain;
    pushLog(state, "收获", `你寻得灵材换得灵石 +${gain}。`, "good");
  } else if(r < 0.85){
    const enemy = genEnemyNearRegion(state, long?0:-1);
    resolveEncounter(state, enemy);
  } else {
    const bonus = state.world._missedSecretBuff ?? 0;
    const ok = rand() < clamp(0.38 + bonus*0.10 + (long?0.08:0), 0.38, 0.85);
    if(ok){
      p.insight += 1;
      state.world._missedSecretBuff = Math.max(0, bonus-1);
      pushLog(state, "传闻", "你得一角残图与口述传承，悟性点 +1。", "good");
    }else{
      pushLog(state, "传闻", "你听闻秘境传说，但线索终究无果。", "info");
    }
  }

  recalcStats(state);
}

function genEnemyNearRegion(state, bias){
  // 根据区域主强度生成敌人；允许低/高波动
  const region = REGIONS.find(r=>r.id===state.player.world.regionId) ?? REGIONS[0];
  const center = region.mainRealmIdx;
  const roll = rand();

  let realmIdx = center;
  if(roll < 0.20) realmIdx = clamp(center-1,0,REALMS.length-1);
  else if(roll > 0.90) realmIdx = clamp(center+1,0,REALMS.length-1);

  // 加上 bias（探索小敌时倾向更低）
  realmIdx = clamp(realmIdx + bias, 0, REALMS.length-1);

  return {
    name: pick(["路匪","邪修","散修","妖物","宗门弟子"]),
    realmIdx,
    stageIdx: randi(0,2),
    hp: 80 + realmIdx*120 + randi(-10,30),
    atk: 10 + realmIdx*28 + randi(0,10),
    def: 6 + realmIdx*20 + randi(0,10),
    agi: 9 + realmIdx*12 + randi(0,8),
    align: pick([-1,1]),
  };
}

function realmPressure(attackerRealm, defenderRealm){
  const diff = attackerRealm - defenderRealm;
  if(diff>=2) return 0.35; // 两个大境界：几乎压制
  if(diff>=1) return 0.18;
  if(diff<=-2) return -0.22;
  if(diff<=-1) return -0.10;
  return 0.0;
}

// 遭遇（事件化 + 轻量选择）
function resolveEncounter(state, enemy){
  const p=state.player;
  const pr = enemy.realmIdx - p.realmIdx;
  const tag = pr>=2 ? "极危" : (pr>=1?"危险":(pr<=-1?"轻松":"旗鼓相当"));
  const tone = pr>=2 ? "bad" : (pr>=1?"warn":"info");

  openModal(
    `遭遇：${enemy.name}（${REALMS[enemy.realmIdx].name}${REALMS[enemy.realmIdx].stages[enemy.stageIdx]}）`,
    `<div class="cols2">
      <div class="card">
        <div class="small">你与对方狭路相逢。判断：<span class="tag ${toneTag(tone)}">${tag}</span></div>
        <div class="hr"></div>
        <div class="small">你的战力：攻击 ${Math.round(p.atk)} / 防御 ${Math.round(p.def)} / 身法 ${Math.round(p.agi)} / 气血 ${Math.round(p.hp)}/${Math.round(p.maxHp)}</div>
        <div class="small">对方战力：攻击 ${enemy.atk} / 防御 ${enemy.def} / 身法 ${enemy.agi} / 气血 ${enemy.hp}</div>
        <div class="small muted" style="margin-top:8px">境界压制：大境界差距会显著影响逃跑与命中。</div>
      </div>
      <div class="card">
        <div class="small"><b>选择</b></div>
        <div class="hr"></div>
        <div class="small">• 交手：以战论道，胜则得资源。</div>
        <div class="small">• 试图撤退：差一大境界将非常困难。</div>
        <div class="small">• 交涉：偶尔可用灵石化解冲突。</div>
      </div>
    </div>`,
    [
      { text:"交手", cls:"btn primary", onClick: ()=>{ closeModal(); battle(state, enemy); } },
      { text:"撤退", cls:"btn warn", onClick: ()=>{ closeModal(); tryEscape(state, enemy); } },
      { text:"交涉（付50灵石）", cls:"btn", onClick: ()=>{
        closeModal();
        if(p.stones>=50 && rand()<0.55){
          p.stones -= 50;
          pushLog(state,"交涉","你以灵石平息争端，双方各退一步。","info");
        }else{
          pushLog(state,"交涉","交涉失败，对方逼近。","warn");
          battle(state, enemy);
        }
        recalcStats(state); renderAll();
      }},
    ]
  );
}

// 逃跑判定：境界压制很明显
function tryEscape(state, enemy){
  const p=state.player;
  const diff = enemy.realmIdx - p.realmIdx; // 敌比我高为正
  let base = 0.55 + (p.agi - enemy.agi)/120;
  if(diff>=2) base -= 0.55;
  else if(diff>=1) base -= 0.28;
  else if(diff<=-1) base += 0.12;

  if(p.injury) base -= 0.08;
  const chance = clamp(base, 0.02, 0.92);
  if(rand() < chance){
    pushLog(state, "撤退", `你身法一展，成功脱身（成功率约${Math.round(chance*100)}%）。`, "good");
  }else{
    pushLog(state, "撤退", `撤退失败（成功率约${Math.round(chance*100)}%），被迫交手！`, "warn");
    battle(state, enemy);
  }
  recalcStats(state); renderAll();
}

// 轻量战斗：三回合内决胜（事件化）
function battle(state, enemy){
  const p=state.player;
  let eHp = enemy.hp;
  let pHp = p.hp;

  const diffP = realmPressure(p.realmIdx, enemy.realmIdx);
  const diffE = realmPressure(enemy.realmIdx, p.realmIdx);

  // 简化三回合：玩家可选策略
  let round = 1;

  function renderBattle(){
    openModal(
      `战斗回合 ${round}/3`,
      `<div class="cols2">
        <div class="card">
          <div class="small">你：气血 <b>${Math.round(pHp)}</b> / ${Math.round(p.maxHp)}，攻击 <b>${Math.round(p.atk)}</b>，防御 <b>${Math.round(p.def)}</b></div>
          <div class="small muted" style="margin-top:8px">压制影响：你对敌命中/伤害 ${diffP>=0?"+":"−"}${Math.round(Math.abs(diffP)*100)}%</div>
        </div>
        <div class="card">
          <div class="small">敌：气血 <b>${Math.round(eHp)}</b>，攻击 <b>${enemy.atk}</b>，防御 <b>${enemy.def}</b></div>
          <div class="small muted" style="margin-top:8px">压制影响：敌对你命中/伤害 ${diffE>=0?"+":"−"}${Math.round(Math.abs(diffE)*100)}%</div>
        </div>
      </div>`,
      [
        { text:"强攻", cls:"btn primary", onClick: ()=>{ closeModal(); doRound("atk"); } },
        { text:"稳守", cls:"btn", onClick: ()=>{ closeModal(); doRound("def"); } },
        { text:"符箓爆发（耗80灵石）", cls:"btn warn", onClick: ()=>{ closeModal(); doRound("talis"); } },
        { text:"撤退", cls:"btn bad", onClick: ()=>{ closeModal(); tryEscape(state, enemy); } },
      ]
    );
  }

  function doRound(mode){
    // 玩家行动
    let pAtkMul = 1.0, pDefMul = 1.0;
    let extraDmg = 0;
    if(mode==="atk"){ pAtkMul=1.20; pDefMul=0.92; }
    if(mode==="def"){ pAtkMul=0.90; pDefMul=1.25; }
    if(mode==="talis"){
      if(p.stones>=80){
        p.stones -= 80;
        extraDmg = 35 + p.realmIdx*25;
        pAtkMul=1.15; pDefMul=0.95;
        pushLog(state,"符箓","你激发符箓，灵光爆裂。","info");
      }else{
        pushLog(state,"符箓","灵石不足，符箓未能激发。","warn");
        mode="atk"; pAtkMul=1.20; pDefMul=0.92;
      }
    }

    const pHit = clamp(0.78 + (p.agi - enemy.agi)/200 + diffP, 0.15, 0.95);
    const eHit = clamp(0.72 + (enemy.agi - p.agi)/220 + diffE, 0.10, 0.92);

    if(rand()<pHit){
      const dmg = Math.max(1, (p.atk*pAtkMul - enemy.def*0.65)) * (1+diffP);
      const dealt = Math.floor(dmg + extraDmg + randi(0,8));
      eHp -= dealt;
      pushLog(state,"战斗",`你出手命中，对方受创 -${dealt}。`,"info");
    }else{
      pushLog(state,"战斗","你一击落空。","info");
    }

    if(eHp<=0){
      winBattle();
      return;
    }

    // 敌行动
    const eAtkMul = (enemy.realmIdx>p.realmIdx) ? 1.10 : 1.0;
    if(rand()<eHit){
      const dmg = Math.max(1, (enemy.atk*eAtkMul - p.def*pDefMul*0.70)) * (1+diffE);
      const dealt = Math.floor(dmg + randi(0,10));
      pHp -= dealt;
      pushLog(state,"战斗",`敌袭命中，你受伤 -${dealt}。`,"warn");
    }else{
      pushLog(state,"战斗","敌袭未中。","info");
    }

    if(pHp<=0){
      loseBattle();
      return;
    }

    round++;
    if(round<=3){
      renderBattle();
    }else{
      // 三回合后按血量判胜负
      if(pHp >= eHp){
        winBattle(true);
      }else{
        loseBattle(true);
      }
    }
  }

  function winBattle(byJudge=false){
    p.hp = clamp(Math.floor(pHp), 1, p.maxHp);
    const loot = 60 + randi(0,80) + enemy.realmIdx*40;
    p.stones += loot;
    if(rand()<0.35) p.insight += 1;
    const msg = byJudge ? "三回合后你占得上风，敌人遁走。" : "你击退对手。";
    pushLog(state,"胜利",`${msg} 灵石 +${loot}。${rand()<0.35?"悟性点 +1。":""}`,"good");
    recalcStats(state); renderAll();
  }

  function loseBattle(byJudge=false){
    p.hp = clamp(Math.floor(pHp), 0, p.maxHp);
    const injDays = randi(18, 45);
    p.injury = { type:"重伤", daysLeft: injDays, effMul:0.75, desc:"重伤在身，需疗养（修炼效率降低）" };
    const loss = Math.min(p.stones, 80 + randi(0,120));
    p.stones -= loss;
    p.mind = clamp(p.mind - 1.0, -5, 10);
    const msg = byJudge ? "三回合后你落于下风，仓促遁走。" : "你被迫败退。";
    pushLog(state,"败退",`${msg} 失去灵石 -${loss}，并落下【${p.injury.type}】（${injDays}天）。`,"bad");
    recalcStats(state); renderAll();
  }

  renderBattle();
}

// =========================
// UI
// =========================

let STATE = null;

function $(id){ return document.getElementById(id); }

function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

function openModal(title, bodyHtml, buttons){
  $("modalTitle").textContent = title;
  $("modalBody").innerHTML = bodyHtml;
  const ft = $("modalFoot");
  ft.innerHTML = "";
  (buttons||[]).forEach(b=>{
    const btn = document.createElement("button");
    btn.className = b.cls || "btn";
    btn.textContent = b.text;
    btn.onclick = b.onClick || (()=>closeModal());
    ft.appendChild(btn);
  });
  $("modalWrap").style.display = "flex";
}
function closeModal(){ $("modalWrap").style.display = "none"; }

function stateReplace(s){
  STATE = s;
  saveAuto();
  renderAll();
}

function saveAuto(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE));
  }catch(e){}
}

function saveManual(){
  saveAuto();
  pushLog(STATE, "存档", "已保存到本地浏览器存储。", "good");
  renderAll();
}

function exportSave(state){
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `xiuzhen_save_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importSaveFromFile(file){
  const fr = new FileReader();
  fr.onload = ()=>{
    try{
      const obj = JSON.parse(fr.result);
      if(!obj || !obj.player || !obj.time) throw new Error("无效存档");
      obj.version = VERSION;
      STATE = obj;
      ensureWindowsForYear(STATE, getYear(STATE));
      pushLog(STATE, "导入", "存档导入成功。", "good");
      recalcStats(STATE);
      saveAuto();
      renderAll();
    }catch(e){
      alert("导入失败："+e.message);
    }
  };
  fr.readAsText(file, "utf-8");
}

// Tabs
const TABS = [
  { id:"cultivate", name:"修炼/闭关" },
  { id:"break", name:"突破" },
  { id:"explore", name:"地图探索" },
  { id:"sect", name:"宗门" },
  { id:"bag", name:"背包/设置" },
];

function renderTabs(){
  const wrap = $("tabs");
  wrap.innerHTML = "";
  for(const t of TABS){
    const b = document.createElement("button");
    b.className = "tabbtn" + (STATE.ui.tab===t.id ? " active" : "");
    b.textContent = t.name;
    b.onclick = ()=>{
      STATE.ui.tab = t.id;
      renderMain();
      renderTabs();
      saveAuto();
    };
    wrap.appendChild(b);
  }
}

function renderTop(){
  $("nowText").textContent = dateText(STATE);
  $("locText").textContent = `${REGIONS.find(r=>r.id===STATE.player.world.regionId)?.name ?? "未知"} · ${STATE.player.world.loc}`;
  $("lifeText").textContent = lifeText(STATE);
}

function alignTag(val){
  if(val>=40) return {txt:"正", cls:"good"};
  if(val<=-40) return {txt:"邪", cls:"bad"};
  return {txt:"中立", cls:""};
}

function renderChar(){
  const p=STATE.player;
  $("realmText").textContent = realmName(STATE);

  const xpPct = clamp(p.xp/p.xpNeed, 0, 1);
  $("xpText").textContent = `${fmt(p.xp)}/${fmt(p.xpNeed)} (${Math.round(xpPct*100)}%)`;
  $("xpBar").style.width = `${Math.round(xpPct*100)}%`;

  const techPct = clamp(p.tech/1000, 0, 1);
  $("techText").textContent = `${Math.round(p.tech)}/1000`;
  $("techBar").style.width = `${Math.round(techPct*100)}%`;

  const hpPct = clamp(p.hp/p.maxHp, 0, 1);
  $("hpText").textContent = `${Math.round(p.hp)}/${Math.round(p.maxHp)}`;
  $("hpBar").style.width = `${Math.round(hpPct*100)}%`;

  $("stoneText").textContent = fmt(p.stones);
  $("insText").textContent = fmt(p.insight);
  $("atkText").textContent = Math.round(p.atk);
  $("defText").textContent = Math.round(p.def);
  $("agiText").textContent = Math.round(p.agi);
  $("mindText").textContent = p.mind.toFixed(1);

  const age = ageYears(STATE);
  const hint = `年龄 ${age.toFixed(1)} 岁｜${p.sect.joined ? ("宗门："+p.sect.name+"（声望"+p.sect.fame+"）") : "散修"}｜版本 ${VERSION}`;
  $("charHint").textContent = hint;

  const at = alignTag(p.align);
  $("tagAlign").textContent = at.txt;
  $("tagAlign").className = "tag " + at.cls;

  // 状态
  const st = [];
  if(p.injury) st.push(`伤势：${p.injury.type}（${p.injury.daysLeft}天）`);
  if(p.unstableDays>0) st.push(`境界不稳（${p.unstableDays}天）`);
  if(p.demonMark>0) st.push(`心魔印记×${p.demonMark}`);
  if(st.length===0) st.push("良好");

  $("statusText").textContent = st.join("，");
  const desc = [];
  if(p.injury) desc.push(`• ${p.injury.desc}`);
  if(p.unstableDays>0) desc.push("• 境界不稳会轻微降低修炼与战斗表现，可通过时间巩固或闭关巩固。");
  if(p.demonMark>0) desc.push("• 心魔印记会提高心魔事件概率，也会轻微降低突破准备度。");
  if(desc.length===0) desc.push("• 气机圆融，可择机闭关或出门探索机缘。");
  $("statusDesc").textContent = desc.join("\n");
}

function renderUpcoming(){
  $("upcomingText").textContent = upcomingText(STATE);
}

function renderLog(){
  const per = 12;
  const total = STATE.log.length;
  const pages = Math.max(1, Math.ceil(total/per));
  STATE.ui.logPage = clamp(STATE.ui.logPage, 0, pages-1);

  const start = STATE.ui.logPage*per;
  const slice = STATE.log.slice(start, start+per);

  const wrap = $("logList");
  wrap.innerHTML = "";
  for(const e of slice){
    const div = document.createElement("div");
    div.className = "entry";
    const tag = toneTag(e.tone);
    div.innerHTML = `
      <div class="meta">
        <div class="t">${escapeHtml(e.t)}</div>
        <div class="k"><span class="tag ${tag}">${escapeHtml(e.kind)}</span></div>
      </div>
      <div class="txt">${escapeHtml(e.text)}</div>`;
    wrap.appendChild(div);
  }

  $("pageInfo").textContent = `第 ${STATE.ui.logPage+1} / ${pages} 页（共 ${total} 条）`;
  $("btnPrev").disabled = STATE.ui.logPage<=0;
  $("btnNext").disabled = STATE.ui.logPage>=pages-1;
}

function renderMain(){
  const tab = STATE.ui.tab;
  const body = $("mainBody");
  const p = STATE.player;

  if(STATE._gameOver){
    $("mainHint").textContent = "寿元已尽。你可以导出存档或重开。";
  }else{
    $("mainHint").textContent = tab==="cultivate" ? "选择闭关方案。10年闭关风险可控，但会错过世界窗口。" :
      tab==="break" ? "准备充分再冲关。失败更像延期成本，而非毁档。" :
      tab==="explore" ? "探索用于获取资源、悟性线索与外部机缘。" :
      tab==="sect" ? "宗门系统为轻量MVP，后续可扩展正邪势力链。" :
      "管理背包与存档设置。";
  }

  if(tab==="cultivate"){
    const envOpts = ENVIRONMENTS.map(e=>`<option value="${e.id}">${e.name}（效率×${e.eff}，风险×${e.risk}，费用${e.costStone}灵石）</option>`).join("");
    const agentOpts = AGENT_TASKS.map(a=>`<option value="${a.id}">${a.name}${a.desc?("｜"+a.desc):""}</option>`).join("");
    body.innerHTML = `
      <div class="split">
        <div class="card">
          <div class="small"><b>闭关方案</b></div>
          <div class="hr"></div>
          <div class="cols2">
            <div class="field">
              <label>时长</label>
              <select id="rtDays">
                <option value="30">30天（巩固/疗伤/练功法）</option>
                <option value="360">1年（主力档）</option>
                <option value="3600">10年（策略档：错过窗口）</option>
              </select>
            </div>
            <div class="field">
              <label>环境</label>
              <select id="rtEnv">${envOpts}</select>
            </div>
          </div>

          <div style="margin-top:10px" class="field">
            <label>备品（灵石消耗换收益/稳定）</label>
            <div class="checkline">
              ${renderCheck("assistPill")}
              ${renderCheck("protectPill")}
              ${renderCheck("wardTalis")}
              ${renderCheck("stablePow")}
            </div>
          </div>


          <div style="margin-top:10px" class="field">
            <label>心魔应对策略（闭关期间自动执行）</label>
            <select id="rtDemonPolicy">
              <option value="suppress">镇压（最稳）</option>
              <option value="confront">正面应对（稳中求悟）</option>
              <option value="enlighten">借势悟道（高收益，失败会加深印记）</option>
            </select>
            <div class="small muted">提示：这只影响闭关期间触发的心魔事件；你仍可在【设置】里通过“静心”压印记。</div>
          </div>

          <div style="margin-top:10px" class="field">
            <label>代理人（闭关期间补救“错过窗口”损失；需额外运作费用）</label>
            <select id="rtAgent">${agentOpts}</select>
            <div class="small muted">提示：指派代理人不保证成功，但能让长闭关更“策略”。</div>
          </div>

          <div class="hr"></div>
          <div class="btnrow">
            <button class="btn primary" id="btnRetreat">开始闭关</button>
            <button class="btn" id="btnShort">快速：7天小修</button>
            <button class="btn" id="btnHeal">疗伤：30天静养</button>
          </div>
        </div>

        <div class="card">
          <div class="small"><b>预估收益（参考）</b></div>
          <div class="hr"></div>
          <div class="small" id="rtPreview">—</div>
          <div class="hr"></div>
          <div class="small"><b>注意事项</b></div>
          <div class="small muted" style="margin-top:8px; line-height:1.6">
            • 10年闭关风险不会很高，但会错过秘境/拍卖/宗门窗口，并生成《大事记》。<br/>
            • 闭关期间若触发心魔，你可以选择镇压/应对/悟道：悟道收益更高但会加深印记。<br/>
            • 当修为充盈后，可进入【突破】页签冲关；建议先治伤、稳定心境、提升功法熟练。
          </div>
        </div>
      </div>
    `;

    setTimeout(()=>{
      const elDays = $("rtDays"), elEnv=$("rtEnv");
      const updatePreview = ()=>{
        const days = parseInt(elDays.value,10);
        const env = ENVIRONMENTS.find(e=>e.id===elEnv.value) ?? ENVIRONMENTS[0];
        const baseXP = calcBaseCultivationPerDay(STATE);
        const baseTech = calcTechGainPerDay(STATE);
        const xp = baseXP * env.eff * days;
        const tech = baseTech * env.eff * days;
        const risk = retreatRiskProfile(days);
        const qi = Math.round(risk.qi*env.risk*1000)/10;
        const demon = Math.round(risk.demon*1000)/10;
        $("rtPreview").textContent =
          `预计修为 +${fmt(xp)}，功法熟练 +${fmt(tech)}。\n`+
          `风险（基础）：走火约${qi}%（会被护脉丹进一步降低），心魔触发率约${demon}%（会被辟邪符/印记影响）。\n`+
          `备注：闭关并不会自动突破；修为可溢出存储，但突破仍需准备与冲关。`;
      };
      elDays.onchange = updatePreview;
      elEnv.onchange = updatePreview;
      updatePreview();

      $("btnRetreat").onclick = ()=>{
        const plan = {
          days: parseInt($("rtDays").value,10),
          envId: $("rtEnv").value,
          agentTaskId: $("rtAgent").value,
          demonPolicy: $("rtDemonPolicy").value,
          supplies:{
            assistPill: $("ck_assistPill").checked,
            protectPill: $("ck_protectPill").checked,
            wardTalis: $("ck_wardTalis").checked,
            stablePow: $("ck_stablePow").checked,
          }
        };
        runRetreat(STATE, plan);
        saveAuto(); renderAll();
      };
      $("btnShort").onclick = ()=>{
        runRetreat(STATE, {days:7, envId:"wild", agentTaskId:"none", supplies:{}});
        saveAuto(); renderAll();
      };
      $("btnHeal").onclick = ()=>{
        // 静养：不加修为，主要恢复
        pushLog(STATE, "静养", "你闭门静养30天，调理气血。", "info");
        advanceDays(STATE, 30, "静养");
        // 额外恢复
        STATE.player.hp = clamp(STATE.player.hp + Math.floor(STATE.player.maxHp*0.35), 0, STATE.player.maxHp);
        if(STATE.player.injury){
          STATE.player.injury.daysLeft = Math.max(0, STATE.player.injury.daysLeft - 20);
          if(STATE.player.injury.daysLeft===0) STATE.player.injury=null;
        }
        recalcStats(STATE); saveAuto(); renderAll();
      };
    },0);

  } else if(tab==="break"){
    const able = canBreakthrough(STATE);
    const pt = prepTier(STATE);
    body.innerHTML = `
      <div class="split">
        <div class="card">
          <div class="small"><b>冲关面板</b></div>
          <div class="hr"></div>
          <div class="kv"><span>当前境界</span><b>${realmName(STATE)}</b></div>
          <div class="kv"><span>修为充盈</span><b>${Math.round(clamp(p.xp/p.xpNeed,0,1)*100)}%</b></div>
          <div class="kv"><span>准备度评分</span><b>${pt.score} / 100</b></div>
          <div class="kv"><span>准备度等级</span><b>${pt.tier}</b></div>
          <div class="kv"><span>成功率区间（参考）</span><b>${Math.round(pt.range[0]*100)}% ~ ${Math.round(pt.range[1]*100)}%</b></div>
          <div class="hr"></div>
          <div class="small muted" style="line-height:1.6">
            • 口径2：失败更多是“延期成本”（掉少量修为、受伤、需要巩固），不会动不动掉大境界。<br/>
            • 你可在冲关时消耗悟性点（最多3）提高成功率。<br/>
            • 若背包有巩固散，可为一次失败提供“惩罚减半”保底。
          </div>
          <div class="hr"></div>
          <div class="btnrow">
            <button class="btn primary" id="btnBreak" ${able?"":"disabled"}>尝试突破</button>
            <button class="btn warn" id="btnBreakIns" ${able?"":"disabled"}>突破（消耗悟性）</button>
            <button class="btn" id="btnConsolidate">巩固（30天）</button>
          </div>
        </div>

        <div class="card">
          <div class="small"><b>提升准备度的常用手段</b></div>
          <div class="hr"></div>
          <div class="small">1) 把修为条填满（闭关/修炼）。</div>
          <div class="small">2) 提升主修功法熟练（闭关也会涨）。</div>
          <div class="small">3) 处理伤势与境界不稳（静养/时间巩固）。</div>
          <div class="small">4) 降低心魔印记（心魔事件选“镇压/应对成功”）。</div>
          <div class="small">5) 通过探索与事件获得悟性点，再用于冲关加持。</div>
          <div class="hr"></div>
          <div class="small"><b>背包保底</b></div>
          <div class="small muted" style="margin-top:8px">巩固散库存：<b>${p.bag.stabilizePow ?? 0}</b>（失败惩罚减半一次）</div>
        </div>
      </div>
    `;
    setTimeout(()=>{
      $("btnBreak").onclick = ()=>{
        attemptBreakthrough(STATE, false);
        saveAuto(); renderAll();
      };
      $("btnBreakIns").onclick = ()=>{
        attemptBreakthrough(STATE, true);
        saveAuto(); renderAll();
      };
      $("btnConsolidate").onclick = ()=>{
        pushLog(STATE, "巩固", "你专注调息30天，稳固气机。", "info");
        advanceDays(STATE, 30, "巩固");
        STATE.player.unstableDays = Math.max(0, STATE.player.unstableDays - 25);
        STATE.player.mind = clamp(STATE.player.mind + 0.4, -5, 10);
        recalcStats(STATE); saveAuto(); renderAll();
      };
    },0);

  } else if(tab==="explore"){
    const regionOpts = REGIONS.map(r=>`<option value="${r.id}">${r.name}（${r.tierHint}｜主强度：${REALMS[r.mainRealmIdx].name}）</option>`).join("");
    body.innerHTML = `
      <div class="split">
        <div class="card">
          <div class="small"><b>游历与探索</b></div>
          <div class="hr"></div>
          <div class="field">
            <label>前往地区</label>
            <select id="exRegion">${regionOpts}</select>
            <div class="small muted">提示：区域有主强度分布，但仍可能遇到更弱或更强的修士/妖物。</div>
          </div>
          <div class="hr"></div>
          <div class="btnrow">
            <button class="btn" id="btnTravel">赶路（7天）</button>
            <button class="btn primary" id="btnExplore7">探索（7天）</button>
            <button class="btn warn" id="btnExplore30">探索（30天）</button>
          </div>
        </div>

        <div class="card">
          <div class="small"><b>探索收益</b></div>
          <div class="hr"></div>
          <div class="small muted" style="line-height:1.6">
            • 灵石：用于闭关环境、备品、符箓等。<br/>
            • 悟性点：主要来自心魔、传闻残图、少量战斗掉落。<br/>
            • 遭遇：不做同级匹配，你可能遇到“误闯”的低阶修士，也可能撞上强敌。
          </div>
        </div>
      </div>
    `;
    setTimeout(()=>{
      $("exRegion").value = p.world.regionId;
      $("btnTravel").onclick = ()=>{
        const rid = $("exRegion").value;
        if(rid === p.world.regionId){
          pushLog(STATE,"赶路","你已在此地，无需奔波。","info");
        }else{
          pushLog(STATE,"赶路",`你启程前往 ${REGIONS.find(r=>r.id===rid)?.name ?? "未知"}，路途7天。`,"info");
          advanceDays(STATE, 7, "赶路");
          p.world.regionId = rid;
          p.world.loc = "野外";
        }
        recalcStats(STATE); saveAuto(); renderAll();
      };
      $("btnExplore7").onclick = ()=>{ explore(STATE, 7); saveAuto(); renderAll(); };
      $("btnExplore30").onclick = ()=>{ explore(STATE, 30); saveAuto(); renderAll(); };
    },0);

  } else if(tab==="sect"){
    body.innerHTML = `
      <div class="split">
        <div class="card">
          <div class="small"><b>宗门（轻量MVP）</b></div>
          <div class="hr"></div>
          <div class="small">当前：<b>${p.sect.joined ? p.sect.name : "未入宗门"}</b></div>
          <div class="small muted" style="margin-top:6px">后续可扩展：一流/二流/三流、正邪、势力战争、追杀/庇护链。</div>
          <div class="hr"></div>
          <div class="btnrow">
            <button class="btn primary" id="btnJoin">${p.sect.joined?"查看宗门事务":"加入宗门（测试）"}</button>
            <button class="btn" id="btnWork">接差事（30天）</button>
          </div>
        </div>

        <div class="card">
          <div class="small"><b>宗门收益（后续扩展方向）</b></div>
          <div class="hr"></div>
          <div class="small muted" style="line-height:1.6">
            • 宗门洞府：修炼效率提升、风险下降。<br/>
            • 贡献兑换：突破材料、延寿丹、护道符箓。<br/>
            • 声望影响：代理人成本/成功率、事件援助概率。<br/>
            • 正邪值与仇怨：影响遭遇、追杀、交易渠道。
          </div>
        </div>
      </div>
    `;
    setTimeout(()=>{
      $("btnJoin").onclick = ()=>{
        if(!p.sect.joined){
          p.sect.joined = true;
          p.sect.name = pick(["清虚宗","天衡宗","落霞门","玄风谷"]);
          p.sect.tier = "三流";
          p.sect.align = "正";
          p.sect.fame = 10;
          p.sect.contrib = 0;
          p.world.loc = "宗门洞府";
          pushLog(STATE, "宗门", `你加入${p.sect.name}，分配到宗门洞府修行。`, "good");
        }else{
          openModal(
            "宗门事务",
            `<div class="card">
              <div class="small">宗门：<b>${p.sect.name}</b>（${p.sect.tier}${p.sect.align}）</div>
              <div class="small">声望：<b>${p.sect.fame}</b>｜贡献：<b>${p.sect.contrib}</b></div>
              <div class="hr"></div>
              <div class="small muted">MVP：目前仅开放“差事”与“洞府修炼”加成。后续可扩展宗门战、收徒、秘境分配等。</div>
            </div>`,
            [{text:"知道了", cls:"btn primary", onClick: ()=>closeModal()}]
          );
        }
        recalcStats(STATE); saveAuto(); renderAll();
      };
      $("btnWork").onclick = ()=>{
        pushLog(STATE, "差事", "你闭关之外接了宗门/江湖差事30天，换取资源。", "info");
        advanceDays(STATE, 30, "差事");
        const gain = 120 + randi(0,120);
        p.stones += gain;
        if(p.sect.joined){
          p.sect.contrib += 30;
          p.sect.fame += 5;
        }
        pushLog(STATE, "差事", `差事完成，灵石 +${gain}${p.sect.joined?("，贡献 +30，声望 +5"):""}。`, "good");
        recalcStats(STATE); saveAuto(); renderAll();
      };
    },0);

  } else if(tab==="bag"){
    body.innerHTML = `
      <div class="split">
        <div class="card">
          <div class="small"><b>背包</b></div>
          <div class="hr"></div>
          <div class="kv"><span>巩固散</span><b>${p.bag.stabilizePow ?? 0}</b></div>
          <div class="small muted" style="margin-top:10px; line-height:1.6">
            巩固散来源：在【修炼/闭关】勾选备品即可购买并入包（用于一次失败惩罚减半保底）。
          </div>
          <div class="hr"></div>
          <div class="btnrow">
            <button class="btn" id="btnBuyPow">购买巩固散（200灵石）</button>
            <button class="btn warn" id="btnSpendMind">静心（7天）</button>
          </div>
        </div>

        <div class="card">
          <div class="small"><b>设置</b></div>
          <div class="hr"></div>
          <div class="btnrow">
            <button class="btn" id="btnSave2">保存</button>
            <button class="btn" id="btnExport2">导出存档</button>
            <button class="btn" id="btnImport2">导入存档</button>
            <button class="btn bad" id="btnReset2">重开</button>
          </div>
          <div class="hr"></div>
          <div class="small muted" style="line-height:1.6">
            • 存档保存在浏览器本地。建议重要节点导出 JSON 备份。<br/>
            • 如果你在 GitHub Pages 上玩，清理浏览器缓存可能会丢存档；导出可避免。<br/>
            • 本版本重点实现“修炼/闭关/突破”骨架，宗门与事件库会在后续扩展。
          </div>
        </div>
      </div>
    `;
    setTimeout(()=>{
      $("btnBuyPow").onclick = ()=>{
        if(p.stones>=200){
          p.stones -= 200;
          p.bag.stabilizePow = (p.bag.stabilizePow ?? 0) + 1;
          pushLog(STATE, "购买", "你购得巩固散×1。", "good");
        }else{
          pushLog(STATE, "购买", "灵石不足。", "warn");
        }
        recalcStats(STATE); saveAuto(); renderAll();
      };
      $("btnSpendMind").onclick = ()=>{
        pushLog(STATE, "静心", "你静坐七日，压下杂念。", "info");
        advanceDays(STATE, 7, "静心");
        p.mind = clamp(p.mind + 0.8, -5, 10);
        if(p.demonMark>0 && rand()<0.40) p.demonMark -= 1;
        recalcStats(STATE); saveAuto(); renderAll();
      };
      $("btnSave2").onclick = saveManual;
      $("btnExport2").onclick = ()=>exportSave(STATE);
      $("btnImport2").onclick = ()=>triggerImport();
      $("btnReset2").onclick = ()=>resetGame();
    },0);
  }

  // disable actions if game over
  if(STATE._gameOver){
    const buttons = body.querySelectorAll("button");
    buttons.forEach(b=>{
      if(!["btnExport2","btnImport2","btnReset2"].includes(b.id)) b.disabled = true;
    });
  }
}

function renderCheck(key){
  const it = SUPPLIES[key];
  return `<label class="check"><input type="checkbox" id="ck_${it.id}"/> <span>${it.name}</span> <span class="muted">(${it.costStone})</span></label>`;
}

function renderAll(){
  renderTabs();
  renderTop();
  renderChar();
  renderUpcoming();
  renderMain();
  renderLog();
}

function triggerImport(){
  const inp = document.createElement("input");
  inp.type="file";
  inp.accept="application/json";
  inp.onchange = ()=>{
    const f = inp.files?.[0];
    if(f) importSaveFromFile(f);
  };
  inp.click();
}

function resetGame(){
  openModal(
    "确认重开",
    `<div class="card"><div class="small danger"><b>重开会清空本地存档。</b></div><div class="small muted" style="margin-top:8px">建议先导出存档备份。</div></div>`,
    [
      { text:"导出备份", cls:"btn", onClick: ()=>exportSave(STATE) },
      { text:"确认重开", cls:"btn bad", onClick: ()=>{ closeModal(); localStorage.removeItem(STORAGE_KEY); stateReplace(newGame()); } },
      { text:"取消", cls:"btn", onClick: ()=>closeModal() },
    ]
  );
}

// =========================
// Boot
// =========================

function loadOrNew(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const s = JSON.parse(raw);
      if(s && s.player && s.time){
        s.version = VERSION;
        // 兼容字段
        s.ui ??= { tab:"cultivate", logPage:0 };
        s.log ??= [];
        s.world ??= { windows:[], lastWindowGenYear:0, npcs:{rivals:[]}, lastChronicle:null };
        s.player.bag ??= { stabilizePow:0 };
        ensureWindowsForYear(s, getYear(s));
        recalcStats(s);
        pushLog(s, "系统", "已读取本地存档。", "good");
        return s;
      }
    }
  }catch(e){}
  return newGame();
}

document.addEventListener("DOMContentLoaded", ()=>{
  STATE = loadOrNew();

  // global buttons
  $("btnSave").onclick = saveManual;
  $("btnExport").onclick = ()=>exportSave(STATE);
  $("btnImport").onclick = ()=>triggerImport();
  $("btnReset").onclick = ()=>resetGame();
  $("btnClearLog").onclick = ()=>{
    openModal(
      "清空日志",
      `<div class="card"><div class="small">确认清空事件日志？存档不会删除。</div></div>`,
      [
        { text:"确认清空", cls:"btn bad", onClick: ()=>{
          closeModal();
          STATE.log = [];
          STATE.ui.logPage = 0;
          pushLog(STATE, "系统", "事件日志已清空。", "info");
          saveAuto(); renderAll();
        }},
        { text:"取消", cls:"btn", onClick: ()=>closeModal() },
      ]
    );
  };

  $("btnPrev").onclick = ()=>{ STATE.ui.logPage = Math.max(0, STATE.ui.logPage-1); renderLog(); saveAuto(); };
  $("btnNext").onclick = ()=>{ STATE.ui.logPage += 1; renderLog(); saveAuto(); };

  $("modalClose").onclick = closeModal;
  $("modalWrap").addEventListener("click", (e)=>{ if(e.target === $("modalWrap")) closeModal(); });

  renderAll();
});
</script>
</body>
</html>
